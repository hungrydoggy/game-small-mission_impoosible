Obj:
  include_part:
    '''{
      #include "scripts/common/rank_item.h"
    '''

  ref:
    'popup_h': {'$popup_h': {'!*':['$game_height', 0.8]}}
    'fnt_col': {'$fnt_col': {'!col.cod': '375e2b'}}

  fnc:
    'setLevelScore':
      '''{(NodeLoadable* loadable, int level, int score)
        auto self = loadable->cast<GameComponent>();

        self->findByNamePath<GameObject>("./content/txt.level.val")->setText(std::to_string(level));
        self->findByNamePath<GameObject>("./content/txt.score.val")->setText(std::to_string(score));
      '''

    'setRank':
      '''{(NodeLoadable* loadable, vector<RankItem>* rank_items, int my_score)
        auto self = loadable->cast<GameComponent>();

        stringstream ss;
        likely (rank_items != null) {
          for (auto& itm : *rank_items)
            ss << itm.score << endl;
        }
        self->findByNamePath<GameObject>("./content/txt.rank.val")->setText(ss.str());

        auto highlight = self->findByNamePath("./content/highlight");
        highlight->is_drawable_self(false);
        likely (rank_items != null) {
          for (int ri=0; ri<rank_items->size(); ++ri) {
            unlikely ((*rank_items)[ri].score == my_score) {
              highlight->callFunc("setPos", {Var(ri)});
              break;
            }
          }
        }
      '''

  chl:
    - Obj:
      nam: 'back_panel'
      pos: [0, 0, -0.1]
      col: [0, 0, 0, 0.8]
      vie:
        ImageView:
          tex: 'textures/white.png'
          siz: ['$game_width', '$game_height']
      bdy:
        BulletBody:
          mas: 0
      shp:
        - BulletBox:
          hsz: {'!shp.hszFromImg': '.'}

    - Cmp:
      nam:'content'
      pos: [0, 15, 0]
      chl:
        - Obj:
          nam: 'bg'
          pos: [0, 0, 0]
          vie:
            ImageView:
              tex: 'textures/game_scene/result_popup.bg.png'
              siz: [0, '$popup_h']
        - Obj:
          nam: 'txt.level.stt'
          pos: [12, '!+':['!*':['$popup_h', 0.5], -100], 0.2]
          scl: [0.85, 0.85, 1]
          col: '$fnt_col'
          vie:
            BitmapFontView:
              bmf: '$bmf_game_ui'
              hor: 'right'
              spc: -1.5
              txt: 'Level : '
        - Obj:
          nam: 'txt.level.val'
          pos: [20, '!+':['!*':['$popup_h', 0.5], -100], 0.2]
          scl: [0.85, 0.85, 1]
          col: '$fnt_col'
          vie:
            BitmapFontView:
              bmf: '$bmf_game_ui'
              hor: 'left'
              spc: -1.5
              txt: '10'

        - Obj:
          nam: 'txt.score.stt'
          pos: [12, '!+':['!*':['$popup_h', 0.5], -132], 0.2]
          scl: [0.85, 0.85, 1]
          col: '$fnt_col'
          vie:
            BitmapFontView:
              bmf: '$bmf_game_ui'
              hor: 'right'
              spc: -1.5
              txt: 'Score : '
        - Obj:
          nam: 'txt.score.val'
          pos: [20, '!+':['!*':['$popup_h', 0.5], -132], 0.2]
          scl: [0.85, 0.85, 1]
          col: '$fnt_col'
          vie:
            BitmapFontView:
              bmf: '$bmf_game_ui'
              hor: 'left'
              spc: -1.5
              txt: '1000'

        - Obj:
          nam: 'txt.rank.stt'
          pos: [-75, '!+':['!*':['$popup_h', 0.5], -165], 0.2]
          scl: [0.75, 0.75, 1]
          col: '$fnt_col'
          vie:
            BitmapFontView:
              bmf: '$bmf_game_ui.sm'
              hor: 'right'
              ver: 'top'
              lin: 1.05
              spc: -1.5
              txt: '1.\n2.\n3.\n4.\n5.\n6.\n7.\n8.\n9.\n10.'
        - Obj:
          nam: 'txt.rank.val'
          pos: [90, '!+':['!*':['$popup_h', 0.5], -165], 0.2]
          scl: [0.75, 0.75, 1]
          col: '$fnt_col'
          vie:
            BitmapFontView:
              bmf: '$bmf_game_ui.sm'
              hor: 'right'
              ver: 'top'
              lin: 1.05
              spc: -1.5
              txt: ''

        - Obj:
          ref:
            'base_y': {'!+':['!*':['$popup_h', 0.5], -172]}
          dat:
            'base_y': '$base_y'
          fnc:
            'setPos':
              '''{(NodeLoadable* loadable, int idx)
                auto self = loadable->cast<GameComponent>();
                self->y(self->getData("base_y", REAL(0.0)) - 21.25 * idx);
                self->is_drawable_self(true);
              '''
          dra: false
          nam: 'highlight'
          pos: [0, '!+':['$base_y', -10], 0.1]
          col: [1, 1, 0, 1]
          vie:
            ImageView:
              tex: 'textures/white.png'
              siz: [230, 25]

    - Obj:
      nam: 'btn.restart'
      pos: [0, '!+':['!*':['$popup_h', -0.5], -15], 0.1]
      vie:
        ImageView:
          tex: 'textures/game_scene/btn.restart.png'
          siz: [110, 0]
      bdy:
        BulletBody:
          mas: 0
          msk: ['%pick']
      shp:
        - BulletBox:
          hsz: {'!shp.hszFromImg': '.'}
      acl:
        - ActionItem:
          nam:'%onPointDown.1'
          act:
            Sequence:
              chl:
                - SetInputProcessable:
                  val: false
                - ScaleTo:
                  dur: 0.1
                  val: [1.1, 1.1, 1]
                  int: OUT_QUAD
                - ScaleTo:
                  dur: 0.1
                  val: [1, 1, 1]
                  int: OUT_QUAD
                - SetAction:
                  tar: '~'
                  nam: 'hide'
                - CallFunc:
                  tar: '/'
                  nam: 'resetGame'

  acl:
    - ActionItem:
      nam: 'show'
      act:
        Sequence:
          chl:
            - SetInputProcessable:
              val: false

            - AlphaTo:
              dur: 0
              val: 0
            - SetDrawable:
              val: true
            - AlphaTo:
              dur: 0.5
              val: 1
              int: OUT_QUAD

            - SetInputProcessable:
              val: true

    - ActionItem:
      nam: 'hide'
      act:
        Sequence:
          chl:
            - SetInputProcessable:
              val: false

            - AlphaTo:
              dur: 0.5
              val: 0
              int: OUT_QUAD
            - SetDrawable:
              val: false

            - SetInputProcessable:
              val: true
