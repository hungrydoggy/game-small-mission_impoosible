Fsm:
  neck_part:
    '''{
      using namespace appetizer;

      // returns view component
      static GameComponent* __playSprite (GameObject* self, string const& name);

      static void __onHit (Fsm* fsm);
    '''

  sta: 'moveRight'
  stt:
    - FsmState:
      nam: 'idle'
      on_enter:
        '''{(Fsm* fsm)
          __playSprite(fsm->owner(), "idle");
        '''
      msg:
        'moveLeft':
          '''{(Fsm* fsm)
            fsm->setCurState("move.left");
          '''
        'moveRight':
          '''{(Fsm* fsm)
            fsm->setCurState("move.right");
          '''
        'onHit':
          '''{(Fsm* fsm)
            __onHit(fsm);
          '''

    - FsmState:
      nam: 'move.left'
      on_enter:
        '''{(Fsm* fsm)
          auto view = __playSprite(fsm->owner(), "run");
          view->scale_x(-1);
        '''
      on_update:
        '''{(Fsm* fsm, , double delta_time)
          auto self = fsm->owner();
          auto move_vel = self->getData("move_vel", 0.0);
          self->x(math::max(self->x() - move_vel * delta_time, self->scene()->getData("bound.left", 0.0)));
        '''
      msg:
        'stopMove':
          '''{(Fsm* fsm)
            fsm->setCurState("idle");
          '''
        'moveRight':
          '''{(Fsm* fsm)
            fsm->setCurState("move.right");
          '''
        'onHit':
          '''{(Fsm* fsm)
            __onHit(fsm);
          '''

    - FsmState:
      nam: 'move.right'
      on_enter:
        '''{(Fsm* fsm)
          auto view = __playSprite(fsm->owner(), "run");
          view->scale_x(1);
        '''
      on_update:
        '''{(Fsm* fsm, , double delta_time)
          auto self = fsm->owner();
          auto move_vel = self->getData("move_vel", 0.0);
          self->x(math::min(self->x() + move_vel * delta_time, self->scene()->getData("bound.right", 0.0)));
        '''
      msg:
        'stopMove':
          '''{(Fsm* fsm)
            fsm->setCurState("idle");
          '''
        'moveLeft':
          '''{(Fsm* fsm)
            fsm->setCurState("move.left");
          '''
        'onHit':
          '''{(Fsm* fsm)
            __onHit(fsm);
          '''

    - FsmState:
      nam: 'hit'
      on_enter:
        '''{(Fsm* fsm)
          auto self = fsm->owner();
          __playSprite(self, "hit");
          self->setAction("hit");
        '''
      msg:
        'onEndHitSprite':
          '''{(Fsm* fsm)
            fsm->owner()->setAction("invincible");
            fsm->setCurState("idle");
          '''

  hip_part:
    '''{
      GameComponent* __playSprite (GameObject* self, string const& name) {
        auto view = self->findChild("view").get();
        self->sendMessage(view, "selectChild", {Var(name)});
        auto spr = view->findChild<GameObject>(name)->getTrait<View>("view")->state<SpriteViewState>();
        spr->play();
        return view;
      }


      void __onHit (Fsm* fsm) {
        auto is_invincible = fsm->owner()->getData("is_invincible", false);
        unlikely (is_invincible == true)
          return;

        fsm->setCurState("hit");
      }
    '''
